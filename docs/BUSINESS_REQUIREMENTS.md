0. 배경 및 역할 요약

역할

제품 공급자(판매자, Merchant)

제품 구매자(소비자, Buyer)

운영자/스폰서(Operator/Sponsor)

오프체인 오케스트레이터(Offchain Server: 모니터링, 가스대납, 환불/정산 트리거)


온체인 구성 요소

Factory → 캠페인별 Campaign Escrow 배포

Campaign Escrow(R2S 핵심) → 예치, 취소, 정산 상태관리

Strategy Adapter(ERC-4626 유사) → DeFi 스테이킹/언스테이킹

RebatePool → 스폰서/마케팅 예산 관리

Distributor → 정산 시점 분배 산식 적용(cap/floor, 가중치)


핵심 원칙

원금 100% 환불(정책 조건 범위 내), 리베이트는 판촉/할인 성격

규칙의 진실은 온체인(오프체인은 호출·배치·가스대납)




---

1. 유즈케이스(UC)

각 UC는 목적, 흐름, 예외, 성공조건을 포함합니다.

UC-01. 판매자의 공동구매 캠페인 개설

목적: 판매자가 상품/기간/컷라인/리베이트 정책을 정의하여 캠페인을 개설

액터: Merchant, Factory

사전조건: 머천트 승인(옵션), 정산 계정 등록

기본 흐름: 파라미터 입력 → Factory 검증 → Campaign Escrow 배포 → 상태 Recruiting

예외: 파라미터 오류, 승인 실패

성공조건: Campaign 주소 발급, 메타데이터 고정, 공유용 링크 생성

관련 기능: F-20, F-61, F-62


UC-02. 스폰서 예산 할당

목적: 최소 리베이트 보장(SaveFloor) 및 캠페인 프로모션

액터: Sponsor, RebatePool

흐름: 스폰서 펀딩 → 캠페인별 할당 → 잔액 조회

예외: 한도 초과, 권한 없음

성공조건: 캠페인에 sponsorBudget 반영

관련 기능: F-41, F-71


UC-03. 구매자의 캠페인 참여(예치)

목적: Buyer가 USDT를 에스크로 예치하여 공동구매 참여

액터: Buyer, Campaign

흐름: 상세 화면에서 금액 입력 → 승인/예치(가스 대납) → 참여 영수증

예외: 기간 외 참여, 잔액 부족

성공조건: 참여자 레코드 생성, idleAssets 증가, 공유 유도

관련 기능: F-01, F-04, F-63


UC-04. 자동 스테이킹/리밸런싱

목적: reserveRatio를 유지하면서 초과 Idle을 전략에 예치

액터: Campaign, Strategy, Operator

흐름: 참여 후/주기적 pokeStake → deposit() 호출 → stakedShares 증가

예외: 전략 비가용, 실패 재시도

성공조건: 목표 Idle 대비 초과분이 스테이킹 상태 유지

관련 기능: F-65, F-96


UC-05. 구매자의 취소 요청(즉시/지연 환불)

목적: Buyer가 예치를 취소하고 환불

액터: Buyer, Campaign, Operator

흐름: requestCancel → Idle 충분 시 즉시 환불 / 부족 시 취소 큐 등록 → Operator가 processCancelQueue로 언스테이크 후 환불

예외: 정책상 취소 불가 타이밍, 부분 취소

성공조건: 환불 완료 이벤트 및 영수증

관련 기능: F-05, F-66, F-97


UC-06. 컷라인 달성 및 판매자 이행 확인

목적: minQty 달성 후 판매자가 이행 확정

액터: Merchant, Campaign

흐름: Reached 판정 → confirmFulfillment → 정산 준비

예외: 이행 지연, 취소 급증

성공조건: 상태 Fulfillment 전환

관련 기능: F-23, F-67


UC-07. 정산(수익 회수, 리베이트 분배, 판매자/운영자 지급)

목적: 실현 이자+스폰서 예산으로 리베이트 분배, 판매자 정산

액터: Operator, Campaign, Strategy, Distributor

흐름: harvestYield → settle() → 분배 산식 적용(cap/floor, 가중치) → 지급

예외: 전략 출금 지연, 스폰서 잔액 부족

성공조건: 사용자 리베이트 지급, 판매자/운영자 지급, 상태 Settled

관련 기능: F-68, F-72, F-98


UC-08. 실패/취소 및 전액 환불

목적: 기간 종료 시 minQty 미달 또는 운영자 취소

액터: Campaign, Operator

흐름: refundAll() → 언스테이크 필요 시 처리 → 원금 100% 환불

예외: 일부 언스테이크 지연

성공조건: 전원 환불, 상태 Failed/Canceled

관련 기능: F-69, F-99


UC-09. 분쟁 처리

목적: 미이행/품질 문제 등 분쟁 발생 시 처리

액터: Buyer, Merchant, Operator

흐름: 증빙 업로드(오프체인) → 온체인 상태 락/타임락 → 판정 후 환불/부분정산

예외: 장기 미응답

성공조건: 판정 반영, 지급/환불 완료

관련 기능: F-33, F-103


UC-10. 비상 언와인드

목적: 전략/시장 이상 시 스테이킹 자산 긴급 회수

액터: Operator

흐름: emergencyUnwind → 환불 우선 처리 → 신규 스테이킹 중단

성공조건: Idle 복구, 리스크 해소

관련 기능: F-70, F-100


UC-11. 전략 화이트리스트/리스크 파라미터 관리

목적: 연결 가능한 전략 제한, reserveRatio/상한/바닥 설정

액터: Operator(Admin)

성공조건: 정책 변경이 즉시 반영되고 이벤트 로깅

관련 기능: F-64, F-73, F-120


UC-12. 알림/바이럴 전파

목적: 마감 임박, 컷라인 근접, 정산 완료 등 푸시/공유

액터: Buyer, Mini Dapp, Offchain

성공조건: 참여율/전환율 증가

관련 기능: F-11, F-12, F-106


UC-13. KYC/리스크/봇 대응

목적: 다계정/봇/이상거래 방지, 한도/속도 제한

액터: Risk Engine

성공조건: 차단/추가 인증 유도

관련 기능: F-122, F-123, F-124


UC-14. 회계/리포트

목적: 판매자 정산서, 운영 리포트, 스폰서 집행 리포트 제공

액터: Merchant, Operator, Sponsor

성공조건: 다운로드/검증 가능한 증빙 제공

관련 기능: F-31, F-42, F-108



---

2. 기능 명세(Features)

기능은 영역별 번호로 정리합니다. 각 기능은 목적, 상세, 의존성, 엣지케이스, 수용기준(TDD 포인트)을 포함합니다.

A. 미니댑: 사용자 기능 (F-01 ~ F-19)

F-01 캠페인 탐색/카드 리스트

상세: 가격, 진행률, SaveFloor, 상한, 마감시간, 참여수 표시

의존성: F-61, F-96 인덱싱

수용기준: 페이지네이션, 정렬, 필터(마감 임박/인기)


F-02 캠페인 상세/예상 결제 계산기

상세: Est. You Pay, Est. Rebate(범위/상한), 정책 고지

수용기준: 라운딩 규칙 일관, 슬라이더 입력시 실시간 반영


F-03 월렛 온보딩 및 키복구 안내

상세: 소셜 로그인/키보호(AA 또는 MPC 연계는 차기)

수용기준: 1분 내 온보딩, 재접속 시 세션 유지


F-04 가스 대납 참여 플로우

상세: approve+join을 리레이어로 일괄 처리

수용기준: 승인 실패/재시도 백오프


F-05 취소 요청/상태 표시

상세: 즉시 환불/대기열 상태 구분, 예상 처리 시간 안내

엣지: 부분취소, 잔액 부족 경고

수용기준: 상태 전이 이벤트 수신 후 UI 갱신


F-06 정산 결과/영수증 보기

상세: 실결제가, 리베이트 내역, 트랜잭션 링크

수용기준: CSV/PDF 내보내기


F-07 환불 결과/증빙

상세: 전액 환불 내역, 사유, 타임스탬프

수용기준: 분쟁 시 제출 가능한 수준


F-08 분쟁 접수 UI

상세: 사유/증빙 업로드, 타임락 안내

수용기준: 진행 상황 트래킹


F-09 접근성/지역화

상세: KR/JP/EN, 통화 소수점(USDT 6 decimals) 표기

수용기준: i18n 키와 법적 문구 분리


F-10 보안/세션 관리

상세: 디바이스 바인딩, 재로그인, 세션만료

수용기준: 동시 세션 제한(옵션)


F-11 알림: 마감 임박/컷라인 근접

수용기준: opt-in/opt-out, 빈도 제한


F-12 공유/초대(라인 친구/그룹)

수용기준: UTM/리퍼럴 태깅


F-13 실패 시 위로 리베이트(옵션)

수용기준: 정책 일관, 이중지급 방지


F-14 KYC/한도 초과 경고

수용기준: 추가 인증 루트 제공


F-15 오류 복구 UX

상세: 승인 실패, 지연 환불 안내


F-16 이용약관/정책 노출

수용기준: SaveFloor, Cap, 환불/분쟁 규칙 명시


F-17 트랜잭션 상태 스트리밍

수용기준: 대기→채굴→확정 이벤트 표시


F-18 접근 통계 동의/거부

수용기준: 쿠키/동의 관리


F-19 튜토리얼 모드(Timeback 설명)

수용기준: 1분 내 학습 완료



B. 머천트 콘솔 (F-20 ~ F-39)

F-20 캠페인 생성 위저드

상세: 가격, 수량 컷, 기간, SaveFloor/Cap, 리스크 정책 선택

수용기준: 사전 검증, 미리보기


F-21 캘린더/재고 연동 필드

수용기준: 재고 상한 경고


F-22 가격/정책 템플릿

수용기준: 재사용 가능 템플릿 저장


F-23 컷라인 달성 알림 및 이행 확정

수용기준: 클릭 한 번으로 confirmFulfillment


F-24 참가자/주문 내역 조회

수용기준: 익명화된 식별자, CSV 내보내기


F-25 정산 리포트/세무

수용기준: 기간별, 캠페인별 필터


F-26 환불/분쟁 대시보드

수용기준: SLA 타이머 표기


F-27 API 키/웹훅

수용기준: 시그니처 검증


F-28 권한/역할 관리

수용기준: 감사 로그


F-29 공지/FAQ 편집

수용기준: 버전 관리


F-30 샘플 배너/소재 다운로드


C. 스폰서/운영자 콘솔 (F-40 ~ F-59)

F-41 스폰서 펀딩/캠페인 할당

F-42 성과 리포트(소진, 전환, CAC 유추)

F-43 SaveFloor 정책 관리

F-44 Cap(상한) 정책 관리

F-45 리퍼럴/어필리에이트 관리

F-46 캠페인 품질 점수/중단 스위치

F-47 리스크 룰 셋 관리

F-48 라벨/세그먼트 마케팅

F-49 알림 시나리오 편집

F-50 내부 감사지표/변경 이력


수용기준: 모든 변경은 이벤트로 온체인에 반영되거나 해시 고정.

D. 스마트컨트랙트(CoC) (F-60 ~ F-79)

F-60 Factory 배포/등록/머천트 승인

F-61 Campaign 생성/메타데이터 고정

F-62 파라미터 유효성 검증

F-63 참여(join)/참여 기록

F-64 전략 화이트리스트/변경 이벤트

F-65 자동/수동 스테이킹(pokeStake)

F-66 취소 요청/큐 등록/즉시 환불

F-67 이행 확정(confirmFulfillment)

F-68 정산(settle)/분배 산식 적용

F-69 실패(refundAll)/취소(cancel)

F-70 비상 언와인드(emergencyUnwind)

F-71 스폰서 예산 할당/회수

F-72 Distributor 결제 실행

F-73 ReserveRatio/Cap/Floor 설정

F-74 이벤트 로깅(완전성)

F-75 재진입/멱등 방지

F-76 상태 전이 인바리언트

F-77 금액 정밀도/라운딩 규칙

F-78 접근제어(RBAC)

F-79 업그레이드 전략(프록시 옵션, MVP는 고정 추천)


각 기능은 유닛/프로퍼티 테스트 케이스를 동반.

E. 오프체인 서비스 (F-90 ~ F-112)

F-90 인덱서/이벤트 서브스크립션

F-91 가스 대납 리레이어

F-92 취소 큐 스케줄러

F-93 전략 상태 폴링/헬스체크

F-94 언스테이크 배치 실행

F-95 정산 배치(수익 회수→settle)

F-96 검색 API/캐시(캠페인/상태/카드용)

F-97 환불 처리 트리거/리트라이

F-98 정산 결과 영수증 생성/보관

F-99 실패 시 전체 환불 시나리오 오케스트레이션

F-100 비상 언와인드 오케스트레이션

F-101 서명/키보안(HSM/키보관)

F-102 감사 로그/트레이스

F-103 분쟁 케이스 관리(증빙 스토리지)

F-104 알림 게이트웨이(푸시/라인 메시지)

F-105 리퍼럴 추적/어트리뷰션

F-106 공유 단축 URL/캠페인 태깅

F-107 메트릭 수집/대시보드

F-108 리포트 생성기(PDF/CSV)

F-109 장애 알림/온콜

F-110 환경 분리(Dev/Test/Prod)

F-111 속도 제한/봇 차단 프록시

F-112 백업/스냅샷 정책


F. 리스크/컴플라이언스 (F-120 ~ F-129)

F-120 전략 승인 프로세스/체크리스트

F-121 RW(읽기)/WW(쓰기) 권한 분리

F-122 KYC 플로우/한도 단계

F-123 AML 룰/고위험국가 차단

F-124 디바이스 바인딩/시그널

F-125 속도/금액 한도/냉각시간

F-126 민감로그 마스킹

F-127 데이터 보존 기간/삭제

F-128 법정 문구/약관 버전 관리

F-129 외부 감사지원(증빙 패키지)


G. 분석/성장 (F-140 ~ F-149)

F-140 퍼널 분석(노출→참여→정산)

F-141 A/B 테스트(카피/SaveFloor/Cap)

F-142 LTV/재참여율 측정

F-143 코호트/세그먼트 리텐션

F-144 바이럴 지수(K-factor)

F-145 캠페인 품질 점수(환불/분쟁율)

F-146 스폰서 ROI 분석

F-147 비용 구조 분석(가스/오퍼레이션)

F-148 대시보드(머천트/스폰서/운영자)

F-149 데이터 익명화/프라이버시


H. 인프라/운영 (F-160 ~ F-169)

F-160 IaC로 환경 프로비저닝

F-161 CI/CD, 카나리 릴리스

F-162 Observability(로그/트레이스/메트릭)

F-163 SLA/SLO 정의

F-164 장애 복구 런북

F-165 비용 모니터링

F-166 보안 스캐닝/서드파티 점검

F-167 키/비밀 관리

F-168 성능/부하 테스트

F-169 데이터 마이그레이션 전략



---

3. UC ↔ Feature 매핑(발췌)

UC	핵심 기능

UC-01 개설	F-20, F-60~F-63
UC-02 스폰서	F-41, F-71, F-42
UC-03 참여	F-01~F-04, F-63
UC-04 스테이킹	F-65, F-96
UC-05 취소	F-05, F-66, F-92, F-97
UC-06 이행확정	F-23, F-67
UC-07 정산	F-68, F-72, F-95, F-98
UC-08 실패환불	F-69, F-99
UC-09 분쟁	F-33, F-103
UC-10 비상언와인드	F-70, F-100
UC-11 전략/정책	F-64, F-73, F-120
UC-12 알림/바이럴	F-11, F-12, F-104, F-106
UC-13 리스크	F-122~F-125, F-111
UC-14 리포트	F-31, F-108